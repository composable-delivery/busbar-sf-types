name: Update Salesforce Types

on:
  schedule:
    # Run daily at 00:00 UTC
    - cron: '0 0 * * *'
  workflow_dispatch:
  # Also run when Dependabot updates package.json
  pull_request:
    paths:
      - 'package.json'

# Prevent concurrent workflow runs from conflicting
concurrency:
  group: update-salesforce-types-${{ github.event_name }}-${{ github.ref }}
  cancel-in-progress: false

permissions:
  contents: write
  pull-requests: write

jobs:
  update-types:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
        with:
          ref: ${{ github.head_ref }}
      
      - name: Set up Node.js
        uses: actions/setup-node@v6
        with:
          node-version: '20'
          cache: 'npm'

      - name: Set up Rust
        uses: dtolnay/rust-toolchain@stable

      - uses: Swatinem/rust-cache@v2

      - name: Install dependencies (fetches @salesforce/types)
        run: npm ci

      - name: Regenerate Rust types
        run: bash ./scripts/generate.sh

      - name: Extract @salesforce/types version
        id: versions
        run: |
          SFDC_VERSION=$(cat .typegen-reports/salesforce_types_version.txt)
          echo "salesforce_types_version=$SFDC_VERSION" >> $GITHUB_OUTPUT
          
          # For now, crate version matches salesforce/types major.minor
          # This can be updated if different versioning scheme is needed
          CRATE_VERSION="$SFDC_VERSION"
          echo "crate_version=$CRATE_VERSION" >> $GITHUB_OUTPUT
          
          echo "Salesforce Types Version: $SFDC_VERSION"
          echo "Crate Version: $CRATE_VERSION"

      - name: Check if open PR exists for this version
        id: check-pr
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          SFDC_VERSION: ${{ steps.versions.outputs.salesforce_types_version }}
        run: |
          # Search for existing PRs with version-based branch name pattern
          # Branch format: types/salesforce-X.Y.Z
          BRANCH_PATTERN="types/salesforce-${SFDC_VERSION}"
          
          PR_COUNT=$(gh pr list \
            --head "$BRANCH_PATTERN" \
            --state open \
            --json number \
            --jq 'length' 2>/dev/null || echo "0")
          
          if [ "$PR_COUNT" -gt 0 ]; then
            echo "has_open_pr=true" >> $GITHUB_OUTPUT
            echo "Found existing open PR for version $SFDC_VERSION"
          else
            echo "has_open_pr=false" >> $GITHUB_OUTPUT
            echo "No existing PR for version $SFDC_VERSION"
          fi

      - name: Check for changes
        id: git-check
        run: |
          # Use git status to also detect untracked new files (e.g., new category modules)
          if [[ -n "$(git status --porcelain=v1)" ]]; then
            echo "changes=true" >> $GITHUB_OUTPUT
          else
            echo "changes=false" >> $GITHUB_OUTPUT
          fi

      - name: Commit and Push changes
        if: steps.git-check.outputs.changes == 'true'
        run: |
          git config --global user.name 'github-actions[bot]'
          git config --global user.email 'github-actions[bot]@users.noreply.github.com'
          git add crates/sf-types/src/ .typegen-reports/
          
          # If this is a PR (e.g. from Dependabot), commit to the branch
          if [ "${{ github.event_name }}" == "pull_request" ]; then
             git commit -m "chore: regenerate types for updated @salesforce/types"
             
             # Pull with rebase to handle any remote changes
             git pull --rebase origin ${{ github.head_ref }} || {
               echo "Rebase failed, aborting rebase and trying merge"
               git rebase --abort
               git pull origin ${{ github.head_ref }}
             }
             
             # Retry push up to 3 times in case of race conditions
             for i in 1 2 3; do
               if git push; then
                 echo "Push succeeded"
                 break
               else
                 if [ $i -lt 3 ]; then
                   echo "Push failed, attempt $i of 3. Pulling and retrying..."
                   git pull --rebase origin ${{ github.head_ref }} || {
                     git rebase --abort
                     git pull origin ${{ github.head_ref }}
                   }
                   sleep 2
                 else
                   echo "Push failed after 3 attempts"
                   exit 1
                 fi
               fi
             done
          else
             # If this is a scheduled/manual run, only create PR if no existing PR for this version
             if [ "${{ steps.check-pr.outputs.has_open_pr }}" == "true" ]; then
               echo "Skipping PR creation: open PR already exists for @salesforce/types@${{ steps.versions.outputs.salesforce_types_version }}"
               exit 0
             fi
             
             # Create PR with version-based branch name
             # Branch format: types/salesforce-X.Y.Z
             BRANCH_NAME="types/salesforce-${{ steps.versions.outputs.salesforce_types_version }}"
             CRATE_VERSION="${{ steps.versions.outputs.crate_version }}"
             
             git commit -m "chore: regenerate types for @salesforce/types@${{ steps.versions.outputs.salesforce_types_version }}"
             git checkout -b "$BRANCH_NAME"
             
              # Retry push up to 3 times
              for i in 1 2 3; do
                if git push origin "$BRANCH_NAME"; then
                  echo "Push succeeded"
                  gh pr create \
                    --title "chore: types for @salesforce/types@${{ steps.versions.outputs.salesforce_types_version }} (crate v$CRATE_VERSION)" \
                    --body $'## Generated from @salesforce/types@${{ steps.versions.outputs.salesforce_types_version }}\n\nAutomatically generated types update.\n\n**Source**: @salesforce/types@${{ steps.versions.outputs.salesforce_types_version }}\n**Crate Version**: '$CRATE_VERSION$'\n\nThis crate is fully auto-generated. No manual type definitionsâ€”only Salesforce metadata via codegen.\n\nChanges are tracked in \`.typegen-reports/\` for CI automation.' \
                    --label "automation" \
                    --label "types" || echo "PR may already exist"
                  break
               else
                 if [ $i -lt 3 ]; then
                   echo "Push failed, attempt $i of 3. Retrying..."
                   sleep 2
                 else
                   echo "Push failed after 3 attempts"
                   exit 1
                 fi
               fi
             done
          fi
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
